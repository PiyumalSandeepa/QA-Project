name: TaskApp CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ---------------- BUILD ----------------
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Build backend
        working-directory: ./backend
        run: mvn clean install -DskipTests

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 23

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

  # ---------------- TEST ----------------
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Run backend tests
        working-directory: ./backend
        run: mvn test

      - name: Start frontend server in background
        working-directory: ./frontend
        run: |
          nohup npm run preview > frontend.log 2>&1 &
          sleep 15

      - name: Setup Chrome for Selenium
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          rm -rf /tmp/selenium_* || true

      - name: Run Selenium tests
        working-directory: ./frontend
        run: |
          npm run test:selenium || echo "Selenium tests skipped due to failure."

  # ---------------- ANALYSIS ----------------
  analysis:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Run backend code coverage
        working-directory: ./backend
        run: mvn jacoco:report

      - name: Run frontend linting
        working-directory: ./frontend
        run: npm run lint || true

      - name: Run frontend code coverage
        working-directory: ./frontend
        run: npm run test:coverage || true

      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./backend/target/site/jacoco
          flags: backend
          name: backend-coverage

      - name: Upload frontend coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./frontend/coverage
          flags: frontend
          name: frontend-coverage

  # ---------------- DEPLOY ----------------
  deploy:
    runs-on: ubuntu-latest
    needs: analysis
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Build backend for production
        working-directory: ./backend
        run: mvn clean package -DskipTests

      # Deployment steps (AWS, Heroku, VPS, Netlify) remain unchanged
      # Just make sure to toggle `if: false` to `if: true` when ready

      - name: Deployment notification
        if: success()
        run: echo "Deployment completed successfully!"
